<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pretend-To-Care Dashboard</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="layout">
        <div class="main">
            <header>
                <div class="header-left">
                    <h1 data-i18n="title">Pretend to care Dashboard</h1>
                    <div class="tg-status offline" id="tgStatus">
                        <svg viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                        <span></span>
                    </div>
                </div>
                <div class="header-btns">
                    <button class="lang-btn active" onclick="setLang('ru')">RU</button>
                    <button class="lang-btn" onclick="setLang('en')">EN</button>
                    <button class="btn" onclick="showAddModal()" data-i18n="add_contact">+ Добавить</button>
                </div>
            </header>
            <div class="contacts-grid" id="contacts"></div>
        </div>
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title" data-i18n="logs">Логи</span>
                <button class="btn btn-sm btn-danger" onclick="clearLogs()" data-i18n="clear">Очистить</button>
            </div>
            <div class="logs-container" id="logs"></div>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-title" data-i18n="new_contact">Новый контакт</div>
            <div class="form-row">
                <label data-i18n="name">Имя</label>
                <input id="newName" placeholder="">
            </div>
            <div class="form-row">
                <label data-i18n="phone">Телефон</label>
                <input id="newPhone" placeholder="+7...">
            </div>
            <div class="modal-btns">
                <button class="btn btn-secondary" onclick="hideAddModal()" data-i18n="cancel">Отмена</button>
                <button class="btn btn-success" onclick="createContact()" data-i18n="create">Создать</button>
            </div>
        </div>
    </div>

    <script src="i18n.js"></script>
    <script>
        const API = '/api';
        let config = { contacts: [] };
        let logs = [];
        let lang = localStorage.getItem('lang') || 'ru';
        let openTabs = {};

        const DAYS_KEYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

        function t(key) { return i18n[lang][key] || key; }

        function setLang(l) {
            lang = l;
            localStorage.setItem('lang', l);
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.textContent === l.toUpperCase()));
            document.querySelectorAll('[data-i18n]').forEach(el => {
                if (el.id === 'tgStatus' || el.parentElement?.id === 'tgStatus') return;
                el.textContent = t(el.dataset.i18n);
            });
            const statusEl = document.getElementById('tgStatus');
            const isOnline = statusEl.classList.contains('online');
            statusEl.querySelector('span').textContent = t(isOnline ? 'online' : 'offline');
            render();
            renderLogs();
        }

        async function load() {
            const [configRes, logsRes] = await Promise.all([
                fetch(`${API}/config`),
                fetch(`${API}/logs`)
            ]);
            config = await configRes.json();
            logs = await logsRes.json();
            if (!config.contacts) config.contacts = [];
            render();
            renderLogs();
        }

        async function save() {
            await fetch(`${API}/config`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
        }

        function render() {
            const el = document.getElementById('contacts');
            if (!config.contacts.length) {
                el.innerHTML = `<div class="empty">${t('no_contacts')}</div>`;
                return;
            }
            el.innerHTML = config.contacts.map((c, i) => renderCard(c, i)).join('');
        }

        function getTabContent(c, idx, tab) {
            const w = c.weather || {};
            const days = t('days');

            if (tab === 'schedule') {
                return `<div class="tab-content">
                    <div class="form-row">
                        <label>${t('name')}</label>
                        <input value="${esc(c.name)}" onchange="updNoRender(${idx},'name',this.value)">
                    </div>
                    <div class="form-row">
                        <label>${t('phone')}</label>
                        <input value="${esc(c.phone)}" onchange="updNoRender(${idx},'phone',this.value)">
                    </div>
                    <div class="schedule-list">
                        ${DAYS_KEYS.map((d, di) => {
                            const s = c.schedule?.[d] || {enabled:false,time:'09:00'};
                            return `<div class="schedule-row ${s.enabled ? 'active' : ''}" id="cell-${idx}-${d}">
                                <span class="day-name">${days[di]}</span>
                                <label class="toggle toggle-mini">
                                    <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="updSchedNoRender(${idx},'${d}','enabled',this.checked)">
                                    <span class="slider"></span>
                                </label>
                                <input type="time" value="${s.time}" onchange="updSchedNoRender(${idx},'${d}','time',this.value)">
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="delete-section">
                        <button class="btn btn-danger btn-sm" onclick="delContact(${idx})">${t('delete_contact')}</button>
                    </div>
                </div>`;
            }

            if (tab === 'messages') {
                return `<div class="tab-content">
                    <div class="messages-list">
                        ${(c.messages||[]).length ? (c.messages||[]).map((m, mi) => `<div class="msg-item">
                            <div class="msg-text">${esc(m)}</div>
                            <span class="msg-del" onclick="delMsg(${idx},${mi})">×</span>
                        </div>`).join('') : `<div class="empty">${t('no_messages')}</div>`}
                    </div>
                    <div class="add-msg">
                        <input id="msg-${idx}" placeholder="${t('add_message')}" onkeypress="if(event.key==='Enter')addMsg(${idx})">
                        <button class="btn btn-sm btn-success" onclick="addMsg(${idx})">${t('add')}</button>
                    </div>
                </div>`;
            }

            if (tab === 'weather') {
                return `<div class="tab-content">
                    <div class="form-row">
                        <label>${t('weather')}</label>
                        <label class="toggle">
                            <input type="checkbox" ${w.enabled ? 'checked' : ''} onchange="updW(${idx},'enabled',this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-row">
                        <label>${t('city')}</label>
                        <input value="${esc(w.city||c.city||'')}" onchange="updW(${idx},'city',this.value)">
                    </div>
                    <div class="form-row">
                        <label>${t('cold_below')}</label>
                        <input type="number" value="${w.cold_threshold||15}" onchange="updW(${idx},'cold_threshold',+this.value)">
                        <span>°C</span>
                    </div>
                    <div class="form-row">
                        <label>${t('heat_above')}</label>
                        <input type="number" value="${w.heat_threshold||30}" onchange="updW(${idx},'heat_threshold',+this.value)">
                        <span>°C</span>
                    </div>
                    <div class="form-row">
                        <label>${t('rain_chance')}</label>
                        <input type="number" value="${w.rain_threshold||60}" onchange="updW(${idx},'rain_threshold',+this.value)">
                        <span>%</span>
                    </div>
                    <div class="form-row">
                        <label>${t('cold_msg')}</label>
                        <input value="${esc(w.cold_message||'')}" onchange="updW(${idx},'cold_message',this.value)" placeholder="Cold...">
                    </div>
                    <div class="form-row">
                        <label>${t('heat_msg')}</label>
                        <input value="${esc(w.heat_message||'')}" onchange="updW(${idx},'heat_message',this.value)" placeholder="Hot...">
                    </div>
                    <div class="form-row">
                        <label>${t('rain_msg')}</label>
                        <input value="${esc(w.rain_message||'')}" onchange="updW(${idx},'rain_message',this.value)" placeholder="Rain...">
                    </div>
                </div>`;
            }

            return '';
        }

        function renderCard(c, idx) {
            const activeTab = openTabs[idx] || null;

            return `<div class="mini-card ${c.enabled ? '' : 'disabled'}">
                <div class="card-top">
                    <div>
                        <div class="card-name">${esc(c.name) || 'New'}</div>
                        <div class="card-phone">${esc(c.phone) || '-'}</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${c.enabled ? 'checked' : ''} onchange="upd(${idx},'enabled',this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="schedule-mini">
                    ${DAYS_KEYS.map((d, di) => {
                        const s = c.schedule?.[d] || {};
                        return `<div class="day-dot ${s.enabled ? 'active' : ''}" title="${s.time || ''}">${t('days_short')[di]}</div>`;
                    }).join('')}
                </div>
                <div class="tabs">
                    <div class="tab ${activeTab==='schedule'?'active':''}" onclick="switchTab(${idx},'schedule')">${t('schedule')}</div>
                    <div class="tab ${activeTab==='messages'?'active':''}" onclick="switchTab(${idx},'messages')">${t('messages')}</div>
                    <div class="tab ${activeTab==='weather'?'active':''}" onclick="switchTab(${idx},'weather')">${t('weather')}</div>
                </div>${activeTab ? getTabContent(c, idx, activeTab) : ''}
            </div>`;
        }

        function renderLogs() {
            const el = document.getElementById('logs');
            if (!logs.length) {
                el.innerHTML = `<div class="empty">${t('no_logs')}</div>`;
                return;
            }
            el.innerHTML = logs.map(l => {
                const typeLabel = l.type === 'sent' ? t('sent') : l.type === 'weather' ? t('weather_sent') : l.type === 'error' ? t('error') : t('info');
                return `
                    <div class="log-item ${l.type}">
                        <div><span class="log-time">${l.time}</span> ${l.contact ? `<span class="log-contact">${esc(l.contact)}</span>` : ''}</div>
                        <div class="log-msg">${typeLabel}: ${esc(l.message)}</div>
                    </div>
                `;
            }).join('');
        }

        function switchTab(idx, tab) {
            if (openTabs[idx] === tab) {
                openTabs = {};
            } else {
                openTabs = {};
                openTabs[idx] = tab;
            }
            render();
        }

        function upd(idx, key, val) {
            config.contacts[idx][key] = val;
            save();
            render();
        }

        function updNoRender(idx, key, val) {
            config.contacts[idx][key] = val;
            save();
        }

        function updSchedNoRender(idx, day, key, val) {
            if (!config.contacts[idx].schedule) config.contacts[idx].schedule = {};
            if (!config.contacts[idx].schedule[day]) config.contacts[idx].schedule[day] = {enabled:false,time:'09:00'};
            config.contacts[idx].schedule[day][key] = val;
            save();

            const row = document.getElementById(`cell-${idx}-${day}`);
            if (row && key === 'enabled') {
                row.classList.toggle('active', val);
                const dot = document.querySelectorAll(`#contacts .mini-card`)[idx]?.querySelectorAll('.day-dot')[DAYS_KEYS.indexOf(day)];
                if (dot) dot.classList.toggle('active', val);
            }
        }

        function updW(idx, key, val) {
            if (!config.contacts[idx].weather) config.contacts[idx].weather = {};
            config.contacts[idx].weather[key] = val;
            save();
        }

        function addMsg(idx) {
            const inp = document.getElementById(`msg-${idx}`);
            if (inp.value.trim()) {
                if (!config.contacts[idx].messages) config.contacts[idx].messages = [];
                config.contacts[idx].messages.push(inp.value.trim());
                inp.value = '';
                save();
                render();
            }
        }

        function delMsg(idx, mi) {
            config.contacts[idx].messages.splice(mi, 1);
            save();
            render();
        }

        function showAddModal() {
            document.getElementById('newName').value = '';
            document.getElementById('newPhone').value = '';
            document.getElementById('addModal').classList.add('show');
        }

        function hideAddModal() {
            document.getElementById('addModal').classList.remove('show');
        }

        function createContact() {
            const name = document.getElementById('newName').value.trim();
            const phone = document.getElementById('newPhone').value.trim();

            if (!name && !phone) return;

            const newContact = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                enabled: true,
                messages: [],
                schedule: {
                    monday:{enabled:true,time:'09:00'},tuesday:{enabled:true,time:'09:00'},
                    wednesday:{enabled:true,time:'09:00'},thursday:{enabled:true,time:'09:00'},
                    friday:{enabled:true,time:'09:00'},saturday:{enabled:true,time:'10:00'},
                    sunday:{enabled:true,time:'10:00'}
                },
                weather: {enabled:false,city:'Tel Aviv',cold_threshold:15,heat_threshold:30,rain_threshold:60,
                    cold_message:'',heat_message:'',rain_message:''}
            };

            config.contacts.push(newContact);
            save();
            render();
            hideAddModal();
        }

        function delContact(idx) {
            if (confirm('Delete?')) {
                config.contacts.splice(idx, 1);
                delete openTabs[idx];
                save();
                render();
            }
        }

        async function clearLogs() {
            try {
                const res = await fetch(`${API}/logs`, { method: 'DELETE' });
                if (res.ok) {
                    logs = [];
                    renderLogs();
                }
            } catch (e) {
                console.error('Clear logs error:', e);
            }
        }

        function esc(s) {
            if (!s) return '';
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        async function checkStatus() {
            try {
                const res = await fetch(`${API}/status`);
                const data = await res.json();
                const el = document.getElementById('tgStatus');
                const span = el.querySelector('span');
                if (data.connected) {
                    el.className = 'tg-status online';
                    span.textContent = t('online');
                } else {
                    el.className = 'tg-status offline';
                    span.textContent = t('offline');
                }
            } catch (e) {
                const el = document.getElementById('tgStatus');
                el.className = 'tg-status offline';
                el.querySelector('span').textContent = t('offline');
            }
        }

        load();
        setLang(lang);
        checkStatus();
        setInterval(async () => {
            const res = await fetch(`${API}/logs`);
            logs = await res.json();
            renderLogs();
            checkStatus();
        }, 5000);
    </script>
</body>
</html>
